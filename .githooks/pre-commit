#!/bin/bash
# Pre-commit hook for Go projects
# Runs go fmt, go vet, and golangci-lint before commit

set -e

echo "Running pre-commit checks..."

# 1. Format check
echo "→ Running go fmt..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "❌ The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w ."
    exit 1
fi
echo "✓ go fmt passed"

# 2. Go vet
echo "→ Running go vet..."
if ! go vet ./...; then
    echo "❌ go vet failed"
    exit 1
fi
echo "✓ go vet passed"

# 3. golangci-lint (if available)
if command -v golangci-lint &> /dev/null; then
    echo "→ Running golangci-lint..."
    if ! golangci-lint run --timeout=5m; then
        echo "❌ golangci-lint failed"
        echo ""
        echo "Fix the issues or run: git commit --no-verify (not recommended)"
        exit 1
    fi
    echo "✓ golangci-lint passed"
else
    echo "⚠️  golangci-lint not found, skipping..."
    echo "   Install: https://golangci-lint.run/usage/install/"
fi

# 4. Run tests (optional, can be slow)
# Uncomment if you want to run tests before every commit
# echo "→ Running tests..."
# if ! go test ./... -short; then
#     echo "❌ Tests failed"
#     exit 1
# fi
# echo "✓ Tests passed"

echo ""
echo "✅ All pre-commit checks passed!"
