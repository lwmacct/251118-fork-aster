---
title: æ¶ˆæ¯å…ƒæ•°æ®
description: ä½¿ç”¨æ¶ˆæ¯å…ƒæ•°æ®æ§åˆ¶æ¶ˆæ¯çš„å¯è§æ€§å’Œåˆ†ç±»
navigation:
  icon: i-lucide-eye
---

# æ¶ˆæ¯å…ƒæ•°æ®

æ¶ˆæ¯å…ƒæ•°æ®ç³»ç»Ÿå…è®¸ç²¾ç»†æ§åˆ¶æ¶ˆæ¯åœ¨ä¸åŒå—ä¼—ï¼ˆç”¨æˆ·ç•Œé¢ã€LLM ä¸Šä¸‹æ–‡ï¼‰ä¸­çš„å¯è§æ€§ã€‚

## ğŸ“‹ æ¦‚è¿°

æ¯æ¡æ¶ˆæ¯å¯ä»¥é™„å¸¦ `MessageMetadata`ï¼Œæ§åˆ¶å…¶å¯è§æ€§å’Œåˆ†ç±»ï¼š

```go
type MessageMetadata struct {
    UserVisible  bool     // æ˜¯å¦å¯¹ç”¨æˆ· UI å¯è§
    AgentVisible bool     // æ˜¯å¦åŒ…å«åœ¨ LLM ä¸Šä¸‹æ–‡ä¸­
    Source       string   // æ¶ˆæ¯æ¥æºæ ‡è¯†
    Tags         []string // è‡ªå®šä¹‰æ ‡ç­¾
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

| åœºæ™¯           | UserVisible | AgentVisible | è¯´æ˜                 |
| -------------- | ----------- | ------------ | -------------------- |
| æ™®é€šæ¶ˆæ¯       | âœ…           | âœ…            | é»˜è®¤è¡Œä¸º             |
| ç³»ç»Ÿæ‘˜è¦       | âŒ           | âœ…            | ç”¨æˆ·æ— éœ€çœ‹åˆ°å†…éƒ¨æ‘˜è¦ |
| ç”¨æˆ·åé¦ˆ       | âœ…           | âŒ            | çº¯å±•ç¤ºï¼Œä¸å½±å“ LLM   |
| å·²å½’æ¡£æ¶ˆæ¯     | âŒ           | âŒ            | å‹ç¼©åçš„æ—§æ¶ˆæ¯       |

## ğŸ› ï¸ åˆ›å»ºæ¶ˆæ¯å…ƒæ•°æ®

### å·¥å‚æ–¹æ³•

```go
import "github.com/astercloud/aster/pkg/types"

// åˆ›å»ºé»˜è®¤å…ƒæ•°æ®ï¼ˆåŒæ–¹å¯è§ï¼‰
meta := types.NewMessageMetadata()

// ä»… Agent å¯è§ï¼ˆç”¨äºæ‘˜è¦ï¼‰
meta := types.NewMessageMetadata().AgentOnly()

// ä»…ç”¨æˆ·å¯è§ï¼ˆç”¨äºåé¦ˆï¼‰
meta := types.NewMessageMetadata().UserOnly()

// åŒæ–¹ä¸å¯è§ï¼ˆå·²å½’æ¡£ï¼‰
meta := types.NewMessageMetadata().Invisible()
```

### é“¾å¼è®¾ç½®

```go
meta := types.NewMessageMetadata().
    AgentOnly().
    WithSource("summary").
    WithTags("context", "compressed")
```

## ğŸ“ é™„åŠ åˆ°æ¶ˆæ¯

```go
msg := types.Message{
    Role:    types.RoleSystem,
    Content: "## å¯¹è¯å†å²æ‘˜è¦\nä¹‹å‰è®¨è®ºäº†é¡¹ç›®æ¶æ„...",
    Metadata: types.NewMessageMetadata().
        AgentOnly().
        WithSource("summary"),
}
```

## ğŸ” è¿‡æ»¤æ¶ˆæ¯

æ ¹æ®å¯è§æ€§è¿‡æ»¤æ¶ˆæ¯åˆ—è¡¨ï¼š

```go
import "github.com/astercloud/aster/pkg/types"

messages := []types.Message{...}

// è¿‡æ»¤å‡º Agent å¯è§çš„æ¶ˆæ¯ï¼ˆå‘é€ç»™ LLMï¼‰
agentMessages := types.FilterMessagesForAgent(messages)

// è¿‡æ»¤å‡ºç”¨æˆ·å¯è§çš„æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºåœ¨ UIï¼‰
userMessages := types.FilterMessagesForUser(messages)

// è‡ªå®šä¹‰è¿‡æ»¤
filtered := types.FilterMessages(messages, func(m *types.Message) bool {
    return m.Metadata == nil || m.Metadata.UserVisible
})

// æŒ‰æ¥æºè¿‡æ»¤
summaries := types.FilterMessagesBySource(messages, "summary")

// æŒ‰æ ‡ç­¾è¿‡æ»¤
important := types.FilterMessagesByTag(messages, "important")
```

## ğŸ”„ ä¸ä¸Šä¸‹æ–‡å‹ç¼©é›†æˆ

æ¶ˆæ¯å…ƒæ•°æ®ä¸ Summarization ä¸­é—´ä»¶é…åˆä½¿ç”¨ï¼š

```go
// å‹ç¼©æ—§æ¶ˆæ¯æ—¶ï¼Œä¸åˆ é™¤è€Œæ˜¯æ ‡è®°ä¸ºä¸å¯è§
for i := range oldMessages {
    if oldMessages[i].Metadata == nil {
        oldMessages[i].Metadata = types.NewMessageMetadata()
    }
    oldMessages[i].Metadata.Invisible()
}

// åˆ›å»ºæ‘˜è¦æ¶ˆæ¯ï¼Œä»… Agent å¯è§
summaryMsg := types.Message{
    Role:    types.RoleSystem,
    Content: summary,
    Metadata: types.NewMessageMetadata().
        AgentOnly().
        WithSource("summary"),
}
```

## ğŸ“Š æ¥æºæ ‡è¯†

æ¨èçš„ `Source` å€¼ï¼š

| æ¥æº       | è¯´æ˜               |
| ---------- | ------------------ |
| `user`     | ç”¨æˆ·è¾“å…¥           |
| `system`   | ç³»ç»Ÿæ¶ˆæ¯           |
| `summary`  | è‡ªåŠ¨ç”Ÿæˆçš„æ‘˜è¦     |
| `tool`     | å·¥å…·æ‰§è¡Œç»“æœ       |
| `memory`   | ä»é•¿æœŸè®°å¿†åŠ è½½     |
| `feedback` | ç”¨æˆ·åé¦ˆ/è¯„ä»·      |

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é»˜è®¤å¯è§**ï¼šä¸è®¾ç½® Metadata çš„æ¶ˆæ¯é»˜è®¤å¯¹åŒæ–¹å¯è§
2. **å‘åå…¼å®¹**ï¼šMetadata ä½¿ç”¨ `omitempty`ï¼Œæ—§æ•°æ®è‡ªåŠ¨å…¼å®¹
3. **æ‘˜è¦æ ‡è®° AgentOnly**ï¼šå‹ç¼©ç”Ÿæˆçš„æ‘˜è¦ä¸éœ€è¦æ˜¾ç¤ºç»™ç”¨æˆ·
4. **ä¿ç•™åŸå§‹æ¶ˆæ¯**ï¼šä½¿ç”¨ Invisible è€Œéåˆ é™¤ï¼Œä¾¿äºå®¡è®¡å’Œæ¢å¤
5. **åˆç†ä½¿ç”¨æ ‡ç­¾**ï¼šTags ç”¨äºä¸šåŠ¡åˆ†ç±»ï¼Œä¾¿äºåç»­æ£€ç´¢

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Summarization ä¸­é—´ä»¶](/middleware/builtin#summarization)
- [ä¼šè¯æŒä¹…åŒ–](/core-concepts/session-persistence)
- [ä¸Šä¸‹æ–‡çª—å£ç®¡ç†](/core-concepts/context-window)
