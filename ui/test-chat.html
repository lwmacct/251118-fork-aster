<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Chat Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 20px;
      color: #4a9eff;
    }
    .status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 8px;
      background: #16213e;
    }
    .status.connected { background: #0f3460; border-left: 4px solid #4a9eff; }
    .messages {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
    }
    .message.user {
      background: #0f3460;
      margin-left: 20%;
    }
    .message.assistant {
      background: #1e3a5f;
      margin-right: 20%;
    }
    .message.system {
      background: #2a2a3e;
      font-size: 0.9em;
      opacity: 0.8;
    }
    .input-area {
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      padding: 12px;
      border: 2px solid #0f3460;
      border-radius: 8px;
      background: #16213e;
      color: #eee;
      font-size: 16px;
    }
    input:focus {
      outline: none;
      border-color: #4a9eff;
    }
    button {
      padding: 12px 24px;
      background: #4a9eff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    button:hover {
      background: #3a8eef;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Aster WebSocket Chat Test</h1>
    
    <div id="status" class="status">
      è¿æ¥çŠ¶æ€: <span id="statusText">æœªè¿æ¥</span>
    </div>

    <div id="messages" class="messages"></div>

    <div class="input-area">
      <input 
        type="text" 
        id="input" 
        placeholder="è¾“å…¥æ¶ˆæ¯..." 
        disabled
      />
      <button id="sendBtn" disabled>å‘é€</button>
    </div>
  </div>

  <script>
    const WS_URL = 'ws://localhost:8080/v1/ws';
    let ws = null;
    
    const statusEl = document.getElementById('status');
    const statusTextEl = document.getElementById('statusText');
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    function addMessage(role, text) {
      const msgEl = document.createElement('div');
      msgEl.className = `message ${role}`;
      msgEl.textContent = text;
      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(connected) {
      if (connected) {
        statusEl.className = 'status connected';
        statusTextEl.textContent = 'å·²è¿æ¥';
        inputEl.disabled = false;
        sendBtn.disabled = false;
      } else {
        statusEl.className = 'status';
        statusTextEl.textContent = 'æœªè¿æ¥';
        inputEl.disabled = true;
        sendBtn.disabled = true;
      }
    }

    function connect() {
      addMessage('system', 'æ­£åœ¨è¿æ¥ WebSocket...');
      
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        addMessage('system', 'âœ… WebSocket å·²è¿æ¥');
        setStatus(true);
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:', msg);

          if (msg.type === 'text_delta' && msg.payload?.text) {
            // è¿½åŠ åˆ°æœ€åä¸€æ¡ assistant æ¶ˆæ¯
            const lastMsg = messagesEl.lastElementChild;
            if (lastMsg && lastMsg.classList.contains('assistant')) {
              lastMsg.textContent += msg.payload.text;
            } else {
              addMessage('assistant', msg.payload.text);
            }
          } else if (msg.type === 'chat_start') {
            addMessage('system', `ğŸ¤– Agent ${msg.payload.agent_id} å¼€å§‹å›å¤...`);
            addMessage('assistant', '');
          } else if (msg.type === 'chat_complete') {
            addMessage('system', 'âœ… å›å¤å®Œæˆ');
          } else if (msg.type === 'error') {
            addMessage('system', `âŒ é”™è¯¯: ${msg.payload?.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        } catch (error) {
          console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket é”™è¯¯:', error);
        addMessage('system', 'âŒ WebSocket é”™è¯¯');
      };

      ws.onclose = () => {
        addMessage('system', 'ğŸ”Œ WebSocket å·²æ–­å¼€');
        setStatus(false);
        
        // 5ç§’åé‡è¿
        setTimeout(() => {
          addMessage('system', 'å°è¯•é‡æ–°è¿æ¥...');
          connect();
        }, 5000);
      };
    }

    function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

      addMessage('user', text);
      inputEl.value = '';

      const message = {
        type: 'chat',
        payload: {
          template_id: 'chat',
          input: text,
          model_config: {
            provider: 'deepseek',
            model: 'deepseek-chat'
          }
        }
      };

      console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', message);
      ws.send(JSON.stringify(message));
    }

    // äº‹ä»¶ç›‘å¬
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // å¯åŠ¨è¿æ¥
    connect();
  </script>
</body>
</html>
